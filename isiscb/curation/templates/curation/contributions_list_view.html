{% extends "curation/list_view.html" %}
{% load addcss %}
{% load general_tags %}
{% load static %}
{% load render_object %}
{% load permission_tags %}

{% block extrahead %}
<script src="{% static 'curation/js/moment.js' %}" type="text/javascript"></script>
{% endblock %}

{% block object_list %}
<script>
//# sourceURL=buttons.js
$('body').ready(function() {
    var form = $('#bulk-form');
    $('#collection-create').click(function() {
        form.attr('action', '{% url "curation:create-citation-collection" %}');
        form.submit();
    });
    $('#collection-add').click(function() {
        form.attr('action', '{% url "curation:add-citation-collection" %}');
        form.submit();
    });
    $('#export').click(function() {
        form.attr('action', '{% url "curation:export-citations" %}');
        form.attr('target', '_blank');
        form.submit();
        e.preventDefault();
    });
    $('#bulk_change_submit').click(function(e) {
      form.attr('action', '{% url "curation:citation-bulk-action" %}');
      form.attr('target', '_blank');
      form.submit();
      e.preventDefault();
    });

    $('.queryset-checkbox').change(function() {
      toggleLinkRecordsBtn();
    });

    $("#select_all").change(function() {
      toggleLinkRecordsBtn();
    });

    $("#link_records_btn").click(function(e) {
      if ($(this).attr("disabled") == false || $(this).attr("disabled") == undefined) {
        $("#linkRecordsModal").modal("show");
      }
      e.preventDefault();
    });
});

function toggleLinkRecordsBtn() {
  if ($('.queryset-checkbox:checked').length > 0) {
    $("#link_records_btn").removeAttr("disabled");
  } else {
    $("#link_records_btn").attr("disabled", "true");
  }
}
</script>

<style>
    .notpublic {
        background-color: #fff;
        border-left: 5px solid #f0ad4e;
      }
</style>

<div id="msgBoxError" class="alert alert-danger" role="alert" style="display: none;">
  <button type="button" class="close" id="closeErrorBoxBtn" aria-label="Close"><span aria-hidden="true">&times;</span></button>
  <div id="msgBoxErrorText"></div>
</div>
<div id="msgBoxSuccess" class="alert alert-success" role="alert" style="display: none;">
  <button type="button" class="close" id="closeSuccessBoxBtn" aria-label="Close"><span aria-hidden="true">&times;</span></button>
  <div id="msgBoxSuccessText"></div>
</div>

<script>
  $(function() {
    $("#closeErrorBoxBtn").click(function() {
      $("#msgBoxError").hide();
      $("#msgBoxErrorText").empty();
    });

    $("#closeSuccessBoxBtn").click(function() {
      $("#msgBoxSuccess").hide();
      $("#msgBoxSuccessText").empty();
    });
  });
</script>

<form action="{% url "curation:citation-bulk-action" %}" method="POST" id="bulk-form" target="_blank">
    {% csrf_token %}
    &nbsp;&nbsp;
    <a class="btn btn-success" href="{% url 'curation:create_citation' %}"><i class="fas fa-plus"></i> Create new citation record</a>

    <input type="hidden" value="{{ filter_params }}" name="filters" />
    <span class="pull-right" style="margin-right: 10px;">Results Count: {{ result_count }}</span>
    <table style="margin-top: 5px;" class="table table-responsive table-hover table-curation">
        <thead>
            <tr>
                <th width="5%">Status</th>
                <th width="5%">ID</th>
                <th width="2%"><i class="fa fa-file-text-o" aria-hidden="true" title="Type"></i></th>
                <th width="15%" style="min-width:300px">Title  <span style="cursor: pointer;" id="sort_title"></span></th>
                <th>Author/Editor(s)</th>
                <th width="5%">Publi. <span style="cursor: pointer;" id="sort_published"></span></th>
                <th width="15%">Periodical</th>
                <th width="3%">Vol.</th>
                <th width="3%">Nr.</th>
                <th width="5%">Pages</th>
                <th width="7%">Modified</th>
                <th width="7%">Created</th>
            </tr>
        </thead>
        <tbody>
            {% for object in filter_list %}
            {% with object.all_acrelations as acrelations %}
            {% with acrelations|get_authorities as authorities %}
            {% with object.all_ccrelations as ccrelations %}
            {% with object|get_citations:ccrelations as related_citations %}
            {% with object.attributes as attributes %}
            <tr class="{% if not object.public or not object.id|are_linked_books_public:related_citations or not object.id|are_linked_journals_public:authorities %}notpublic{% endif %} {% if object.stub_record_status == 'SR'%}stubrecord{%endif%}">
                <td>
                  {% if object.tracking_state == 'None' %}<span class="label label-default label-xs">Draft</span>{% elif object.tracking_state == 'FU' %}<span class="label label-warning label-xs">Under Review</span>{% else %}<span class="label label-success label-xs">Published</span>{% endif %}
                </td>
                <td>
                    <a href="{% url "curation:guest_curate_citation" object.id %}?search={{ search_key }}&current={{ forloop.counter0|add:current_offset }}">{{ object.id }}</a>

                    {% if not object.id|are_related_authorities_public or not object.id|are_related_citations_public or not object.id|are_attributes_public %}
                    <i class="fa fa-exclamation-circle" aria-hidden="true" title="At least one linked record is not public."></i>
                    {% endif %}
                    {% if object|is_public_inconsistent %}
                    <i class="fa fa-exclamation-triangle" aria-hidden="true" title="The public/record status fields are inconsistent."></i>
                    {% endif %}
                    {% if object.record_status_value == record_status_redirect %}
                    <i class="fa fa-share" aria-hidden="true" title="This authority records redirects to another one."></i>
                    {% endif %}
                    {% if object.stub_record_status == 'SR' %}
                    <i style="color: #d0254c" class="fa fa-flag" aria-hidden="true" title="This record is a stub record."></i>
                    {% endif %}
                </td>
                <td><span class="label label-xs label-primary" title="{{object.type_controlled|get_type_controlled_display}}">{{ object.type_controlled|get_type_controlled_display }}</span></td>
                <td id="title-{{object.id}}">{{ object.title_for_display|safe }}</td>
                <td id="authors-{{object.id}}">
                    <a href="{% url "curation:curate_citation" object.id %}?search={{ search_key }}&current={{ forloop.counter0|add:current_offset }}&tab=acrelations">
                        {{ object.id|get_authors_editors_preloaded }}
                    </a>
                </td>
                <td id="date-{{object.id}}">
                    <a href="{% url "curation:curate_citation" object.id %}?tab=attributes">
                        {{ object.publication_date.year }}
                    </a>
                </td>
                <td id="periodical-{{object.id}}">
                    <a href="{% url "curation:curate_citation" object.id %}?tab=acrelations">
                        {{ object.id|get_citation_periodical|truncatechars:31 }}
                    </a>
                </td>
                <td>
                  {% if object.part_details__volume_free_text %}{{ object.part_details__volume_free_text }}{% endif %}
                </td>
                <td>
                  {% if object.part_details__issue_free_text %}{{ object.part_details__issue_free_text }}{% endif %}
                </td>
                <td id="page-{{object.id}}">
                    {{ object|get_page_numbers }}
                </td>
                <td>
                    {% if object.modified_on %}
                      <span class="list_date">{{ object.modified_on|date:"c" }}</span>
                    {% else %}
                      <span class="list_date">{{ object.modified_on_fm|date:"c" }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if object.created_native %}
                      <span class="list_date">{{ object.created_native|date:"c" }}</span>
                      {% else %}
                      {% if object.created_on_fm %}
                        <span class="list_date">{{ object.created_on_fm|date:"c" }}</span>
                      {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% endwith %}
            {% endwith %}
            {% endwith %}
            {% endwith %}
            {% endwith %}
            {% endfor %}
        </tbody>

        </thead>

    </table>
</form>

<div id="linkRecordsModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="link_citations_form">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Link Records</h4>
        </div>
        <div class="modal-body">

          <div id="ccrCreationValidationBox" class="alert alert-danger" role="alert" style="display: none"></div>

          <p>Please select the subject citation for the new CCRelations:</p>
          <select id="ccrSubjectDropdown" name="ccrSubject" class="form-control">
            <option value="">Select one or paste citation ID below</option>
            {% for object in filter_list %}
            <option value="{{object.id}}" data-citation-type="{{object.type_controlled}}">
              [{{ object.type_controlled|get_type_controlled_display|cut_characters:2 }}]
              {{ object.id|get_authors_editors_preloaded }}. {{ object.title_for_display|safe }} ({{ object.publication_date.year }})
            </option>
            {% endfor %}
          <select>
          <p style="margin-top: 20px;">Or enter a citation ID:</p>
          <input type="text" class="form-control" name="pastedCitationId" id="pastedSubjectId" />

          <p style="margin-top: 20px;">Please select the type of the new CCRelations:</p>
          <select name="CCRType" id="CCRType" class="form-control">
              <option value="">--- Select one</option>
            {% for choice in ccrelation_choices %}
              <option value="{{choice.0}}">{{choice.1}}</option>
            {% endfor %}
          </select>

          <div id="hiddenCitationFields"></div>

          <p style="margin-top: 20px;">You have selected the following citations to be linked:</p>
          <div id="citationInListTemplate" data-citation-id="" style="display:none;"></div>
          <div>
            <small id="link_citations_list">

            </small>
          </div>
      </div>
      <div class="modal-footer">
        <div id="ccrCreationButtons">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="submitCCRButton">Link Records</button>
        </div>
        <div id="ccrCreationWarning" style="display: none;">
          <div class="alert alert-warning text-left" role="alert">
            <span id="ccrCreationWarningText"></span>
            <p class="text-right">
            <button id="ccrContinueCreation" class="btn btn-primary btn-sm">Yes, continue!</button>
            <button id="ccrCancelCreation" class="btn btn-default btn-sm">Go back</button>
            </p>
          </div>
        </div>
      </div>
    </form>

    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
//# sourceURL=modals.js
  $(window).load(function() {
    var sortOrder = $("#id_o").val();

    if (sortOrder == "-publication_date") {
      $("#sort_published").addClass("fa fa-sort-amount-desc");
      $("#sort_published").attr("title", "Click to sort by publication date ascending.")
    } else {
      $("#sort_published").addClass("fa fa-sort-amount-asc");
      $("#sort_published").attr("title", "Click to sort by publication date descending.")
    }

    if (sortOrder == '-title_for_sort') {
      $("#sort_title").addClass("fa fa-sort-amount-desc");
      $("#sort_title").attr("title", "Click to sort by title date ascending.")
    } else {
      $("#sort_title").addClass("fa fa-sort-amount-asc");
      $("#sort_title").attr("title", "Click to sort by title date descending.")
    }

    $("#sort_published").on('click', function(e) {
      e.preventDefault();
      if (sortOrder == "-publication_date") {
        $("#id_o").val('publication_date');
      } else {
        $("#id_o").val('-publication_date');
      }
      submitSearchForm();
    });

    $("#sort_title").on('click', function(e) {
      e.preventDefault();
      if (sortOrder == "-title_for_sort") {
        $("#id_o").val('title_for_sort');
      } else {
        $("#id_o").val('-title_for_sort');
      }
      submitSearchForm();
    });

    setdate();

    var options = { weekday: "long", year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" };
    function setdate() {
      $('.list_date').each(function() {
        var date = new Date($(this).text());
        var m = moment(date);

        $(this).text(m.format("YYYY-MM-DD"));
        $(this).attr('title', m.format("YYYY-MM-DD h:mma"));
      });
    }

    $("#linkRecordsModal").on("show.bs.modal", function(e) {
      var citationTypes = [];
      $(".table-curation td").find("input:checked").each(function(idx, input) {
        var citationId = $(input).val();
        var citationDiv = $("#citationInListTemplate").clone();
        citationDiv.removeAttr("id");
        var title = $("#title-" + citationId).text();
        var authors = $("#authors-" + citationId + ">a");
        var authorsArray = [];
        authors.each(function(idx, elem) {
          authorsArray.push($(elem).text());
        });
        var authorsText = authorsArray.join(", ");
        var date = $("#date-" + citationId + ">a").text();
        var page = $("#page-" + citationId).text();
        var periodical = $("#periodical-" + citationId).text();

        var citationText = '<i class="fa fa-check-square-o" aria-hidden="true"></i> ' + authorsText.trim() + ". " + title
        if (periodical) {
          citationText += ". In: " + periodical;
        }
        if (date.trim()) {
          citationText += " (" + date.trim() + ")";
        }
        citationDiv.html(citationText);
        citationDiv.show();
        $("#link_citations_list").append(citationDiv);

        var hiddenInput = $('<input type="hidden" name="citationId"/>');
        hiddenInput.val(citationId);
        hiddenInput.data("citation-type", $(input).data("citation-type"));
        $("#hiddenCitationFields").append(hiddenInput);

        citationTypes.push($(input).data("citation-type"));
      });

      setDefaultCCRType(citationTypes);
    });

    function setDefaultCCRType(citationTypes) {
      if (citationTypes.every( (val, i, types) => val === types[0] ) && citationTypes[0] == "RE") {
        $("#CCRType").val("RB");
        return;
      }
      if (citationTypes.every( (val, i, types) => val === types[0] ) && citationTypes[0] == "CH") {
        $("#CCRType").val("IC");
        return;
      }
      if (citationTypes.every( (val, i, types) => val === types[0] ) && citationTypes[0] == "AR") {
        $("#CCRType").val("ISA");
        return;
      }
    }

    $('#linkRecordsModal').on('hidden.bs.modal', function (e) {
      $("#link_citations_list").empty();
      $("#hiddenCitationFields").empty();
      $("#ccrSubjectDropdown").val('');
      $("#pastedSubjectId").val('');
      $("#CCRType").val('');
      $("#ccrCreationValidationBox").hide();
    });

    $("#submitCCRButton").click(function(e) {
      e.preventDefault();

      var subjectDropDownId = $("#ccrSubjectDropdown").val();
      var subjectPastedId = $("#pastedSubjectId").val();
      var selectedType = $("#CCRType").val();

      if ((subjectDropDownId == null || subjectDropDownId.trim() == "")
              && (subjectPastedId == null || subjectPastedId.trim() == "")) {
        $("#ccrCreationValidationBox").text("Please select a subject citation from the drop down menu or past a citation ID.");
        $("#ccrCreationValidationBox").show();
        return;
      }

      if (selectedType == null || selectedType.trim() == "") {
        $("#ccrCreationValidationBox").text("Please select a type for the new CCRelation.");
        $("#ccrCreationValidationBox").show();
        return;
      }

      if ($("#hiddenCitationFields input").length == 0) {
        $("#ccrCreationValidationBox").text("Please select at least one citation from the list.");
        $("#ccrCreationValidationBox").show();
        return;
      }

      var citationTypes = [];
      $("#hiddenCitationFields input").each(function(idx, input) {
        citationTypes.push($(input).data("citation-type"));
      });
      if (citationTypes.every( (val, i, types) => val === types[0] ) && citationTypes[0] == "RE") {
        var subjectType = $("#ccrSubjectDropdown option:selected").data("citation-type");
        if (subjectType == 'RE' || subjectType == 'ES') {
          $("#ccrCreationValidationBox").text("Subject of CCRelation cannot be a Review or Essay Review. Please select another one.");
          $("#ccrCreationValidationBox").show();
          return;
        }
      }

      var showWarning = false;
      $("#hiddenCitationFields input").each(function(idx, elem) {
        if ($(elem).val() == subjectPastedId || ((subjectPastedId == null || subjectPastedId == '') && $(elem).val() == subjectDropDownId)) {
          $("#ccrCreationButtons").hide();
          $("#ccrCreationWarningText").text("You are about to link " + $(elem).val() + " to itself. Are you sure you want to continue?");
          $("#ccrCreationWarning").show();
          showWarning = true;
          return;
        }
      });

      if (showWarning) {
        $("#ccrCreationValidationBox").hide();
        return;
      }

      submitCCR();
    });

    $("#ccrCancelCreation").click(function(e) {
      e.preventDefault();
      $("#ccrCreationWarningText").text("");
      $("#ccrCreationWarning").hide();
      $("#ccrCreationButtons").show();
    });

    $("#ccrContinueCreation").click(function(e) {
      e.preventDefault();
      submitCCR();
    });

    function submitCCR() {
      data = new FormData(document.querySelector("form#link_citations_form"));
      $.ajax({
        url: '{% url 'curation:bulk-create-ccr' %}',
        data: data,
        contentType : false,
	      processData : false,
	      enctype: 'multipart/form-data',
        type: 'POST',
        success: function ( data ) {
            $('#linkRecordsModal').modal('hide');
            if (data["failed"] == null || data["failed"].length > 0) {
              var failed = $("<div></div>");
              var failedText = "CCRelation creation failed for the following citations (all other succeeded): " + data["failed"];
              failed.text(failedText);
              $("#msgBoxErrorText").append(failed);
              $("#msgBoxError").show();
            } else {
              $("#msgBoxSuccessText").text("CCRelations successfully created.");
              $("#msgBoxSuccess").show();
            }
        },
        error: function (xhr) {
          $('#linkRecordsModal').modal('hide');
          var failed = $("<div></div>");
          var failedText = "An error occured: " + $.parseJSON(xhr.responseText)["msg"];
          failed.text(failedText);
          $("#msgBoxErrorText").append(failed);
          $("#msgBoxError").show();
        }
      });
    }

  });
</script>
{% endblock %}

{% block filter_form %}
<form id="filter_form" action="{% url 'curation:contributions' %}" class="form-horizontal clearfix" method="GET" style="margin-bottom: 0px; margin-top: 10px;">
    <div>
      <div class="col-sm-12">

          {% for error in objects.form.title.errors %}
          <div class="alert alert-warning">{{ error }}</div>
          {% endfor %}
          <div class="form-group form-group-xs clearable">
              <label class="col-lg-2 control-label">{{ objects.form.title.label }}</label>
              <div class="col-lg-10">
                {{ objects.form.title|addcss:"form-control;Title" }}
              </div>
          </div>


          {% for error in objects.form.author_or_editor.errors %}
          <div class="alert alert-warning">{{ error }}</div>
          {% endfor %}
          <div class="form-group form-group-xs clearable">
              <label class="col-lg-2 control-label">Au./Ed.</label>
              <div class="col-lg-10">
                {{ objects.form.author_or_editor|addcss:"form-control;Author/Ed." }}
              </div>
          </div>

          {% for error in objects.form.periodical.errors %}
          <div class="alert alert-warning">{{ error }}</div>
          {% endfor %}
          <div class="form-group form-group-xs clearable">
              <label class="col-lg-2 control-label">Periodical</label>
              <div class="col-lg-10">
                {{ objects.form.periodical|addcss:"form-control;Periodical" }}
              </div>
          </div>

          {% for error in objects.form.publisher.errors %}
          <div class="alert alert-warning">{{ error }}</div>
          {% endfor %}
          <div class="form-group form-group-xs clearable">
              <label class="col-lg-2 control-label">Publisher</label>
              <div class="col-lg-10">
                {{ objects.form.publisher|addcss:"form-control;Publisher" }}
              </div>
          </div>

          {% for error in objects.form.publication_date_from.errors %}
          <div class="alert alert-warning">{{ error }}</div>
          {% endfor %}
          {% for error in objects.form.publication_date_before.errors %}
          <div class="alert alert-warning">{{ error }}</div>
          {% endfor %}
          <div class="form-group form-group-xs clearable has-feedback">
              <label class="col-lg-2 control-label">Pub date</label>
              <div class="col-lg-5" style="padding-right:2px">
                {{ objects.form.publication_date_from|add_popover:"form-control date-input;after" }}
              </div>
              <div class="col-lg-5" style="padding-left:2px">
                {{ objects.form.publication_date_to|add_popover:"form-control date-input;before;All dates in format 2017-05-31;bottom" }}
                <a href="" class="glyphicon glyphicon-question-sign form-control-feedback popover_info"></a>
              </div>
          </div>
          <div class="row">
              <div class="col-xs-12">

              </div>
          </div>

          {% for error in objects.form.type_controlled.errors %}
          <div class="alert alert-warning">{{ error }}</div>
          {% endfor %}
          <div class="form-group form-group-xs clearable">
              <label class="col-lg-2 control-label">Type</label>
              <div class="col-lg-10">
                {{ objects.form.type_controlled|addcss:"form-control;Rec. Type" }}
              </div>
          </div>

          {% for error in objects.form.created_on_from.errors %}
          <div class="alert alert-warning">{{ error }}</div>
          {% endfor %}
          {% for error in objects.form.created_on_to.errors %}
          <div class="alert alert-warning">{{ error }}</div>
          {% endfor %}
          <div class="form-group form-group-xs clearable">
              <label class="col-lg-2 control-label">Created</label>
              <div class="col-lg-5" style="padding-right:2px">
                {{ objects.form.created_on_from|add_popover:"form-control date-input;after" }}
              </div>
              <div class="col-lg-5" style="padding-left:2px">
                {{ objects.form.created_on_to|add_popover:"form-control date-input;before" }}

              </div>
          </div>
      </div>

      <div class="col-sm-12" style="text-align: center;">
          <div class="btn-group">
            <input class="btn btn-primary btn-xs" type="submit" id="submit-form-btn" value="Apply Filters"></input>
            <button class="btn btn-warning btn-xs" type="" id="clear-filters" value="Clear Filters">Clear Filters</button>
          </div>
      </div>
    </div>
</form>

<script>
$(document).ready(function() {
    //# sourceURL=source.js

    $('[data-toggle="popover"]').popover();

    $.each($('select'), function(index, value) {
      if ($(value).val() == '') {
        $(value).css('color', '#888');
      }
    });

    $('select').change(function() {
      if ($(this).val() != '' || $(this).find("option:selected").text() == 'All') {
        $(this).css('color', '#000');
      } else {
        $(this).css('color', '#888');
      }

    });

    /* in collection javascript */
    $('#in_collections_input').bootcomplete({
        url:'{% url 'curation:search-collections' %}',
        minLength: 3,
        idFieldName: 'in_collections'
    });

    $('#in_collections_input').on('input', function() {
        if ($('#in_collections_input').val() == '') {
          $('#id_in_collections').val('');
        }
    });

    /* zotero accession javascript */
    $('#zotero_accession_input').bootcomplete({
        url:'{% url 'curation:search-zotero-accessions' %}',
        minLength: 3,
        idFieldName: 'zotero_accession'
    });

    $('#zotero_accession_input').on('input', function() {
        if ($('#zotero_accession_input').val() == '') {
          $('#id_zotero_accession').val('');
        }
    });

    var date = "{{ objects.zotero_accession_date|date:"c" }}";
    var append = "";
    if (date != null && date != "") {
      append = " (" + new Date().toLocaleString() + ")";
    }
    $('#zotero_accession_input').val("{{objects.zotero_accession_name}}" + append);

    /* 'belongs to' javascript */
    $('#belongs_to_input').bootcomplete({
        url:'{% url 'curation:search-datasets' %}',
        minLength: 3,
        idFieldName: 'belongs_to'
    });

    $('#belongs_to_input').on('input', function() {
        if ($('#belongs_to_input').val() == '') {
          $('#id_belongs_to').val('');
        }
    });

    /* 'creator' javascript */
    $('#creator_input').bootcomplete({
        url:'{% url 'curation:search-users' %}',
        minLength: 3,
        idFieldName: 'created_by_native'
    });

    $('#creator_input').on('input', function() {
        if ($('#creator_input').val() == '') {
          $('#id_created_by_native').val('');
        }
    });

    /* 'modifier' javascript */
    $('#modifier_input').bootcomplete({
        url:'{% url 'curation:search-users' %}',
        minLength: 3,
        idFieldName: 'modified_by'
    });

    $('#modifier_input').on('input', function() {
        if ($('#modifier_input').val() == '') {
          $('#id_modified_by').val('');
        }
    });
});
</script>
{% endblock %}

{% block filter_submit %}
<!-- nothing -->
{% endblock %}
