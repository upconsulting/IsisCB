{% extends "curation/base.html" %}

{% load general_tags %}
{% load addcss %}

{% block content %}


<form class="form" action="{% url 'curation:tenant_settings' tenant.id %}" method="POST" enctype="multipart/form-data" class="form-horizontal">
  <div class=" form-group col-md-12">
  <h2>Tenant: {{tenant.name}}</h2>
  </div>
  {% csrf_token %}
  <div class="form-group  col-md-12">
      {% for error in form.title.errors %}
      <div class="alert alert-danger col-md-2">{{ error }}</div>
      {% endfor %}
      <label class="col-md-2">{{ form.title.label }}</label>
      <div class="col-md-10">
        {{ form.title|addcss:"form-control" }}
      </div>
  </div>

  <div class="form-group  col-md-12">
    {% for error in form.contact_email.errors %}
    <div class="alert alert-danger col-md-2">{{ error }}</div>
    {% endfor %}
    <label class="col-md-2">{{ form.contact_email.label }}</label>
    <div class="col-md-10">
      {{ form.contact_email|addcss:"form-control" }}
    </div>
</div>


  <div class="form-group  col-md-12">
    {% for error in form.logo.errors %}
    <div class="alert alert-danger col-md-2">{{ error }}</div>
    {% endfor %}
    <label class="col-md-2">{{ form.logo.label }}</label>
    <div class="col-md-10">
      {{ form.logo|addcss:"form-control" }}
    </div>
  </div>

  <div class="form-group col-md-12">
    {% for error in form.google_api_key.errors %}
    <div class="alert alert-danger col-md-12">{{ error }}</div>
    {% endfor %}
    <label class="col-md-2">{{ form.google_api_key.label }}</label>
    <div class="col-md-10">
      {{ form.google_api_key|addcss:"form-control" }}
    </div>
  </div>

  <div class="form-group col-md-12">
    {% for error in form.twitter_api_key.errors %}
    <div class="alert alert-danger col-md-12">{{ error }}</div>
    {% endfor %}
    <label class="col-md-2">{{ form.twitter_api_key.label }}</label>
    <div class="col-md-10">
      {{ form.twitter_api_key|addcss:"form-control" }}
    </div>
  </div>

  <div class="form-group col-md-12">
    {% for error in form.twitter_user_name.errors %}
    <div class="alert alert-danger col-md-12">{{ error }}</div>
    {% endfor %}
    <label class="col-md-2">{{ form.twitter_user_name.label }}</label>
    <div class="col-md-10">
      {{ form.twitter_user_name|addcss:"form-control" }}
    </div>
  </div>

  <div class="form-group col-md-12">
      {% for error in form.navigation_color.errors %}
      <div class="alert alert-danger col-md-12">{{ error }}</div>
      {% endfor %}
      <label class="col-md-2">{{ form.navigation_color.label }}</label>
      <div class="col-md-1">
        {{ form.navigation_color|addcss:"form-control" }}
      </div>
  </div>

  <div class="form-group  col-md-12">
      {% for error in form.link_color.errors %}
      <div class="alert alert-danger col-md-12">{{ error }}</div>
      {% endfor %}
      <label class="col-md-2">{{ form.link_color.label }}</label>
      <div class="col-md-1">
        {{ form.link_color|addcss:"form-control" }}
      </div>
  </div>

  <div class="form-group  col-md-12">
    {% for error in form.default_featured_authority.errors %}
    <div class="alert alert-danger col-md-12">{{ error }}</div>
    {% endfor %}
    <label class="col-md-2">{{ form.default_featured_authority.label }}</label>
    <div class="col-md-10">
      <input id="featured_authority_search" type="text" class="form-control" value="{{form.instance.default_featured_authority.name}} ({{form.instance.default_featured_authority.id}})" />
      <ul class="list-group" id="featured_authority_datalist">
      </ul>
      {{ form.default_featured_authority|addcss:"form-control" }}
    </div>
</div>

  <div class="form-group">
    <div class="col-md-12">
    <button class="btn btn-primary" type="submit">Save</button>
    </div>
  </div>
</form>

<script>
  //@ sourceURL=search.js
  function delay(callback, ms) {
    var timer = 0;
    return function() {
      var context = this, args = arguments;
      clearTimeout(timer);
      timer = setTimeout(function () {
        callback.apply(context, args);
      }, ms || 0);
    };
  }

  var INITIAL_MAX_RESULTS = 10;
  var max_results = INITIAL_MAX_RESULTS;
  var search_tenants = true;
    
  function triggerSearch(force){
    var query = $('#featured_authority_search').val();
    var url = "{% url "curation:quick_and_dirty_authority_search" %}?show_inactive=false&use_custom_cmp=false&"  
    url += "&max=" + max_results + "&force=" + force; 
    if (search_tenants) {
      url += "&tenant_ids={{tenant.id}}";
    }
    url += "&q=" + query;
    $.ajax(url, {
      success: function(result) {
        var resultsContainer = $('#featured_authority_datalist');
        resultsContainer.empty();
        result.results.forEach(function(r) {
          var newOption = $('<li class="list-group-item" data-authority-id="' + r.id + '"></li>');

          var linkText = r.name + ' (' + r.citation_count + ') - ' + r.id;
          newOption.html('<a href="#">' + linkText + '</a>')
          newOption.click(function() {
            $("#id_default_featured_authority").val(r.id);
            $("#featured_authority_search").val(linkText);
            resultsContainer.empty();
          })
          resultsContainer.append(newOption);
        });

        if (result.results.length == 0 && ((force && query.length < 3) || (!force && query.length > 2))) {
          var msg = $('<p>There are no results for "' + query +'".</p>');
          resultsContainer.append(msg);
        } else if (result.results.length == 0 && !force && query.length < 3) {
          var msg = $('<p>Your query was too short. </p>');
          var forceLink = $('<a>Press <i class="fa fa-search" aria-hidden="true"></i></a>');
          forceLink.click(function() {
            triggerSearch(true);
          });
          msg.append(forceLink);
          msg.append(" to force the search.");
          resultsContainer.append(msg);
        }

        if (result.results.length == max_results) {
          var load_more = `
            <li class="list-group-item search-result">
              <div class="text-right" id="load-more-subjects"><a>Load more...</a></div>
            </li>
          `;
          resultsContainer.append(load_more);
          $('#load-more-subjects').click(function() {
              max_results += 10;
              triggerSearch(force);
          });
        }
      }
    });
  }

  $(document).ready(function() {

    $("#featured_authority_search").keyup(delay(function (e) {
        triggerSearch(false)
      }, 500));
    });
</script>

{% endblock %}
