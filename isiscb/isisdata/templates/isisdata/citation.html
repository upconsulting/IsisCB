{% extends "isisdata/__base.html" %}
{% load app_filters %}
{% load citation_filters %}
{% load static %}
{% load metadata_filters %}
{% load search_filters %}

{% block meta_tags %}
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="unapi-server" type="application/xml" title="unAPI" href="http://{{ request.get_host }}/isis/unapi">
{% endblock %}

{% block extra_head %}
<script>
{% if source_instance_id %}
var SUBJECT_INSTANCE_ID = "{{ source_instance_id }}";
{% endif %}

{% if source_content_type %}
var SUBJECT_CONTENT_TYPE = {{ source_content_type }};
{% endif %}
</script>

<script src="{% static "isisdata/js/comments.js" %}"></script>

<script type="text/javascript">

    let citationType = "{{ citation.get_type_controlled_display }}";

    console.log(citationType);

    if (citationType === "Book"){
      let citationTitle = "{{citation|get_title|lower}}";
      let apiKey = "AIzaSyCL5NFL222QeXGv6AwbkCirpshZdpHaq5I";
      let isbn

      let url = `https://www.googleapis.com/books/v1/volumes?q=${citationTitle}&key=${apiKey}`;

      fetch(url)
        .then(function(res){
          return res.json();
        })
        .then(function(result){
          items = result.items;

          if (items[0]) {
              console.log(items[0])
              let bookGoogleId = items[0].id;

              let url = `https://www.googleapis.com/books/v1/volumes/${bookGoogleId}?key=${apiKey}&projection=lite`;

              fetch(url)
                .then(function(res){
                  return res.json();
                })
                .then(function(result){

                  console.log(result);

                    let img = "";

                    let imageLinks = Object.keys(result.volumeInfo.imageLinks);

                    if (imageLinks.indexOf("medium") >= 0) {
                        img = result.volumeInfo.imageLinks.medium;
                    } else if (imageLinks.indexOf("small") >= 0) {
                        img = result.volumeInfo.imageLinks.small;
                    } else if (imageLinks.indexOf("thumbnail") >= 0) {
                        img = result.volumeInfo.imageLinks.thumbnail;
                        document.getElementById("citationImage").style.height = "auto";
                    }

                    if (img !== "") {
                      document.getElementById("citationImage").style.display = "block";
                      document.getElementById("citatationImageBreak").style.display = "block";
                      document.getElementById("citationImage").src = img;
                      document.getElementById("citationImageAdjacent").classList.remove("col-md-12");
                      document.getElementById("citationImageAdjacent").classList.add("col-md-6");
                    }

                })
          } else {
            return;
          }
        }),
        function (error) {
          console.log(error);
        };
    } else if (citationType === "Article" || citationType === "Review" || citationType == "Essay Review") {

    }

</script>

<style>
  .truncate {
  text-overflow: ellipsis;
  overflow: hidden;
  display: -webkit-box;
   -webkit-line-clamp: 7;
   -webkit-box-orient: vertical;

   #citationSubjects tr {
     padding-bottom: 20px;
   }
}
</style>

<meta property="og:url"                content="{{ request.build_absolute_uri }}" />
<meta property="og:site_name"          content="Isis Current Bibliography" />
<meta property="og:type"               content="article" />
<meta property="fb:app_id"             content="{{ facebook_app_id}}" />
<meta property="og:title"              content="{{ citation|get_title|strip_tags }}" />
<meta property="og:description"        content="{% if citation.abstract|length > 0 %}{{ citation.abstract|strip_tags|filter_abstract }}{% elif citation.description %}{{ citation.description|strip_tags }}{% endif %}" />
<!-- TODO: -vv- if we add images for entries, this should be changed. -vv-  -->
<meta property="og:image"              content="{% static "isisdata/images/isis_final_black.png" %}" />
{% endblock %}


{#% block title %}Citation{% endblock %#}

{% block content %}
<script>
  $(function () {
  $('[data-toggle="popover"]').popover()
})
</script>

<!-- Progress through search results, if arriving from search view. -->
{% if search_results|length > 0 and fromsearch and search_current %}
<div class="row">
  <div class="col-sm-12 col-md-12">
    <div class="alert alert-info hidden-print" style="padding: 5px">
        <div class="row">
            <div class="col-xs-3 text-center">
                {% if search_current >= 2 and search_previous %}
                <a href="{% url 'citation' search_previous|get_pk %}?fromsearch=true&query_string={{ query_string }}&last_query={{ last_query|encode_query }}" aria-label="Previous" class="btn btn-xs">
                    <div class="btn btn-sm btn-primary"><i class="fas fa-angle-double-left"></i> Previous</div>
                </a>
                {% endif %}
            </div>
            <div class="col-xs-6 text-center" style="font-size:1.1em">
                Showing result {{ search_current }} of {{ search_results|length }}
            </div>
            <div class="col-xs-3 text-center">
                {% if search_index < search_count and search_next %}
                <a href="{% url 'citation' search_next|get_pk %}?fromsearch=true&query_string={{ query_string }}&last_query={{ last_query|encode_query }}" aria-label="Next" class="btn btn-xs">
                    <div class="btn btn-sm btn-primary">Next <i class="fas fa-angle-double-right"></i> </div>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  <div class=" main col-sm-12 col-md-4">
    <div class="panel panel-default">
      <div class="panel-heading">
        <div class="row" style="padding-left: 15px">
          <strong style="font-size:1.4em; color:#012E63">{{ citation.get_type_controlled_display }}</strong>{% if citation.subtype %}<strong>:</Strong><span style="font-size:1.5em">&nbsp{{ citation.subtype.name }}</span>{% endif %}
            <span class="btn-grp pull-right" style="padding-bottom:5px">
              <span class="authorityLink" style="margin-right: 20px;cursor: copy;" title="Click to copy"><i class="fas fa-fingerprint"></i> ID: {{ citation.id }} <i class="far fa-copy"></i></span>
              <textarea style="position: absolute;left: -9999px;" class="hiddenCitationLink">{{ citation | get_uri }}</textarea>
                {% if user.is_staff %}<a class="btn btn-small glyphicon glyphicon-edit" href="{% url "curation:curate_citation" citation.id %}" data-toggle="tooltip" data-placement="top" title="Edit this entry"></a>{% endif %}
                <a class="btn btn-small glyphicon glyphicon-console" href="{{ api_view}}" data-toggle="tooltip" data-placement="top" title="View in REST API"></a>
            </span>
        </div>

        <hr style="margin: 5px 0">

        {% with citation|get_pub_year as pub_year %}
        {% with citation|get_title as citation_title %}
        <h3 style="margin: 0px">{{ citation_title|bleach_safe }} {% if pub_year %}({{ pub_year}}){% endif %}
          {% if citation.stub_record_status == 'SR' %}
          <sup><i data-container="body" data-toggle="popover" data-placement="right" data-trigger="hover" data-content="This record is not fully entered or proofed in the database. Some fields may be blank or incorrect." class="fa fa-exclamation-triangle text-danger" aria-hidden="true"></i></sup>
          {% endif %}
        </h3>
        {% if citation|has_title and citation.complete_citation %}
        <p>
        <strong>Full citation:</strong> {{ citation.complete_citation }}
        </p>
        {% endif %}
        {% endwith %}
        {% endwith %}
      </div>

      <div class="panel-body">
        <span style="display:none;">
           <abbr class="unapi-id" title="{{ citation.id }}">unapi</abbr>
        </span>

        <!-- OpenURL Link Resolver tags. http://ocoins.info/ -->

        <!-- This tag displays an icon/link that points to the users' institution's
             link resolver. -->
        <span id="linkresolver" class="hidden-print">
            <script>
            $.ajax("{% url 'linkresolver' citation_id=citation.id %}",
                {
                    success: function(result) {
                            if (result.url.length > 0) {
                                var linkElem = '<a href="'+ result.url +'" class="text-warnging">';
                                // Use the link_icon for the Resolver if possible; otherwise just use the link_text.
                                if (result.icon.length > 0) { linkElem += '<img src="'+ result.icon +'" alt="'+ result.text +'">'; } else { linkElem += '<span class="h4">' + result.text + '</span>'; };
                                linkElem += '</a>';
                                $('#linkresolver').append(linkElem);
                            } else {
                                // This tag provides data for latent OpenURL functionality (e.g. browser plugins, etc). -->
                                $('#linkresolver').append('<span class="Z3988" title="{{ citation|get_coins_from_citation }}"></span>');
                            }
                    },
                    error: function() {
                        // This tag provides data for latent OpenURL functionality (e.g. browser plugins, etc). -->
                        $('#linkresolver').append('<span class="Z3988" title="{{ citation|get_coins_from_citation }}"></span>');
                    },
                });
            </script>
        </span>

        <script>
          //# sourceURL=copy.js
          $(function() {
            $(".authorityLink").click(function() {
              var copyTextarea = document.querySelector('.hiddenCitationLink');
              copyTextarea.focus();
              copyTextarea.select();
              document.execCommand("copy");
              $.notify("URL of this record has been copied to your clipboard.", "info", {
                clickToHide: true,
                style: 'bootstrap',
                gap: 5,
              });
            })
          })
        </script>

        <div class="col-sm-12 col-md-12" id="citationImageAdjacent" style="padding: 0;">
            {% if authors|length > 0 %}
            <p><span class="label label-default">Authors & Contributors</span><br/>
            {% for acrelation in citation.get_all_contributors %}{% if acrelation.authority %}<a href="{% url 'authority' acrelation.authority.id %}">{{ acrelation.authority.name }}</a> ({{acrelation|get_contributor_role_as_string}})<br/> {% endif %}{% endfor %}
            </p>
            <hr style="margin: 10px 0">
            {% endif %}

            {% if properties_map|length > 0 or citation.part_details.volume|length > 0 or citation.part_details.volume_free_text|length > 0 or citation.part_details.issue_begin or citation.part_details.issue_free_text|length > 0 or citation.part_details.page_begin or citation.part_details.pages_free_text|length > 0 %}
              {% for prop in properties_map %}
              <span class="label label-default props">{{ prop.get_type_controlled_display }}</span><br/>
              {% if prop.authority %}<a href="{% url 'authority' prop.authority.id %}">{{ prop.authority.name }}</a>{% else %} {{ prop.name_for_display_in_citation }}{% endif %}
              <br/>
              {% endfor %}

              {% if citation.part_details.volume|length > 0 or citation.part_details.volume_free_text|length > 0 %}
              <span class="label label-default">Volume</span> {% if citation.part_details.volume|length > 0%}{{ citation.part_details.volume }}{% else %}{{ citation.part_details.volume_free_text}}{% endif %}
              <br/>
              {% endif %}

              {% if citation.part_details.issue_begin or citation.part_details.issue_free_text|length > 0 %}
              <span class="label label-default">Issue</span> {% if citation.part_details.issue_begin %}{{ citation.part_details.issue_begin }}{% if citation.part_details.issue_end %} - {{ citation.part_details.issue_end}}{% endif %}{% else %}{{ citation.part_details.issue_free_text }}{% endif %}
              <br/>
              {% endif %}

              {% if citation.part_details.page_begin or citation.part_details.pages_free_text|length > 0 %}
              <span class="label label-default">Pages</span> {{ citation|get_public_page_string }}
              <br/>
              {% endif %}

              <hr style="margin: 10px 0">
            {% endif %}

            {% if citation.attributes|length > 0 or citation.edition_details|length > 0 or citation.physical_details|length > 0 or citation.language|length > 0 %}
                {% for attribute in citation.attributes.all %}
                <span class="label label-default">{{ attribute.type_controlled.display_name }}</span> {% if attribute.value_freeform %}{{ attribute.value_freeform }}{% else %}{{ attribute.value.display }}{% endif %}
                <br>
                {% endfor %}

                {% if citation.edition_details|length > 0 %}
                  <span class="label label-default">Edition Details</span> {{ citation.edition_details|bleach_safe }}
                  <br>
                {% endif %}

                {% if citation.physical_details|length > 0 %}
                  <span class="label label-default">Physical Details</span> {{ citation.physical_details|bleach_safe }}
                  <br>
                {% endif %}

                {% if citation.extent %}
                  <span class="label label-default">Extent</span> {{ citation.extent|bleach_safe }}
                  <br>
                {% endif %}

                {% if citation.language.all|length > 0 %}
                  <span class="label label-default">Languages</span> {% for language in citation.language.all %}{{ language.name }}{% endfor %}
                  <br>
                {% endif %}

                <hr style="margin: 10px 0">
            {% endif %}

            {% if citation.linkeddata_public.all|length > 0 %}
              <div class="panel panel-info">
                <div class="panel-heading" style="padding: 5px"><span class="glyphicon glyphicon-globe"></span> Linked Data</div>
                <div class="panel-body" style="padding: 5px">
                  {% for entry in citation.linkeddata_public.all %}
                    <span class="label label-primary">{{ entry.type_controlled }}</span><a href="{{ entry|linkeddata_for_display }}" taget="_blank"> {{ entry.universal_resource_name }}</a><br/>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
        </div>
        <div class="col-sm-12 col-md-6" style="padding: 0 0 0 8px;">
          <img id="citationImage" height="300px" width="auto" style="border: 1px solid lightgray; display: none; margin-left: auto; margin-right: auto;">
        </div>
        <div class="col-sm-12 col-md-12" style="padding: 0;">
          <hr style="margin: 10px 0; display: none;" id="citatationImageBreak">

          {% if subjects|length > 0 %}
            <div class="panel panel-default">
              <div class="panel-heading" style="padding: 5px;">
                  <span class="label label-default">Concepts</span>
              </div>
              <div class="panel-body" style="padding: 5px;">
                  {% for subject in subjects %}
                  {% if subject.authority %}
                  <a href="{% url 'authority' subject.authority.id %}">
                      <span class="label label-primary">{{ subject.authority.name }}</span>
                  </a>
                  {% endif %}
                  {% endfor %}
              </div>
            </div>
          {% endif %}

          {% if time_periods|length > 0 %}
            <div class="panel panel-default">
              <div class="panel-heading" style="padding: 5px;">
                  <span class="label label-default">Time Periods</span>
              </div>
              <div class="panel-body" style="padding: 5px;">
                {% for time in time_periods %}
                {% if time.authority %}
                <a href="{% url 'authority' time.authority.id %}">
                    <span class="label label-primary">{{ time.authority.name }}</span>
                </a>
                {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% if citation.abstract %}
          <p class="itemAbstract truncate" style="margin-bottom: 0"><span class="label label-default">Abstract</span> {{ citation.abstract|filter_abstract|bleach_safe }}</p>
          <a class="readMore">...More</a>
          <hr style="margin: 10px 0">
          {% endif %}

          {% if citation.description %}
          <p><span class="label label-default">Description</span> {{ citation.description|bleach_safe }}</p>
          <hr style="margin: 10px 0">
          {% endif %}

          <!-- <div></div> -->
          {% if related_citations_rb %}
            <div class="panel panel-default">
              <div class="panel-heading">
                 <i class="fas fa-book"></i> <i class="fas fa-arrow-right"></i> <i class="far fa-file-alt"></i> Reviewed By
              </div>
              <div class="panel-body">
                  {% for cc_rel in related_citations_rb %}
                    {% with cc_rel.object as citation_object %}
                      {% include "isisdata/citation_entry.html" %}
                    {% endwith %}
                  {% endfor %}
              </div>
            </div>
          {% endif %}

          <!-- Review of -->
          {% if related_citations_ro or related_citations_inv_rb %}
          <div class="panel panel-default">
            <div class="panel-heading">
              <i class="far fa-file-alt"></i> <i class="fas fa-arrow-right"></i> <i class="fas fa-book"></i> Review Of
            </div>
            <div class="panel-body">
                {% for cc_rel in related_citations_ro %}
                {% if cc_rel.subject.id == citation_id %}
                  {% with cc_rel.object as citation_object %}
                    {% include "isisdata/citation_entry.html" %}
                  {% endwith %}
                {% else %}
                  {% with cc_rel.subject as citation_object %}
                    {% include "isisdata/citation_entry.html" %}
                  {% endwith %}
                {% endif %}
                {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Includes Chapter -->
          {% if related_citations_ic %}
            <div class="panel panel-default">
              <div class="panel-heading">
                <i class="fas fa-book"></i> <i class="fas fa-arrows-alt-h"></i> <i class="fas fa-book-open"></i> Includes Chapters
              </div>
              <div class="panel-body">
                  {% for cc_rel in related_citations_ic %}
                    {% with cc_rel.object as citation_object %}
                      {% include "isisdata/citation_entry.html" %}
                    {% endwith %}
                  {% endfor %}
              </div>
            </div>
          {% endif %}

          {% if related_citations_inv_ic %}
          <div class="panel panel-default">
            <div class="panel-heading">
              <i class="fas fa-book-open"></i> <i class="fas fa-arrows-alt-h"></i> <i class="fas fa-book"></i> Included in
            </div>
            <div class="panel-body">
                {% for cc_rel in related_citations_inv_ic %}
                {% with cc_rel.subject as citation_object %}
                  {% include "isisdata/citation_entry.html" %}
                {% endwith %}
                {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Includes Series Article -->
          {% if related_citations_isa %}
          <div class="panel panel-default">
            <div class="panel-heading">
              <i class="far fa-file-alt"></i> <i class="fas fa-arrow-right"></i> <i class="far fa-file-alt"></i> Includes Series Articles
            </div>
            <div class="panel-body">
                {% for cc_rel in related_citations_isa %}
                  {% with cc_rel.object as citation_object %}
                    {% include "isisdata/citation_entry.html" %}
                  {% endwith %}
                {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if related_citations_inv_isa %}
          <div class="panel panel-default">
            <div class="panel-heading">
              <i class="far fa-file-alt"></i> <i class="fas fa-arrow-right"></i> <i class="far fa-file-alt"></i> Included in
            </div>
            <div class="panel-body">
                {% for cc_rel in related_citations_inv_isa %}
                  {% with cc_rel.subject as citation_object %}
                    {% include "isisdata/citation_entry.html" %}
                  {% endwith %}
                {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Response to -->
          {% if related_citations_re %}
          <div class="panel panel-default">
            <div class="panel-heading">
              <i class="far fa-file-alt"></i> <i class="fas fa-arrow-right"></i> <i class="far fa-file-alt"></i> Response to
            </div>
            <div class="panel-body">
                {% for cc_rel in related_citations_re %}
                  {% with cc_rel.object as citation_object %}
                    {% include "isisdata/citation_entry.html" %}
                  {% endwith %}
                {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if related_citations_inv_re %}
          <div class="panel panel-default">
            <div class="panel-heading">
              <i class="far fa-file-alt"></i> <i class="fas fa-arrow-right"></i> <i class="far fa-file-alt"></i> Has Response
            </div>
            <div class="panel-body">
                {% for cc_rel in related_citations_inv_re %}
                  {% with cc_rel.subject as citation_object %}
                    {% include "isisdata/citation_entry.html" %}
                  {% endwith %}
                {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Associated with -->
          {% if related_citations_as %}
          <div class="panel panel-default">
            <div class="panel-heading">
              <i class="far fa-file-alt"></i> <i class="fas fa-arrows-alt-h"></i> <i class="far fa-file-alt"></i> Associated with
            </div>
            <div class="panel-body">
                {% for cc_rel in related_citations_as %}
                  {% if cc_rel.subject.id == citation.id %}
                  {% with cc_rel.object as citation_object %}
                    {% include "isisdata/citation_entry.html" %}
                  {% endwith %}
                  {% else %}
                  {% with cc_rel.subject as citation_object %}
                    {% include "isisdata/citation_entry.html" %}
                  {% endwith %}
                  {% endif %}
                {% endfor %}
            </div>
          </div>
          {% endif %}

        <div class="panel panel-default">
            <div class="panel-heading-links panel-heading">
                <i class="fas fa-search"></i> Outside Citation Search
            </div>
            <div class="panel-body panel-body-links">

              {% if citation.get_type_controlled_display == "Book"%}
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Google_%22G%22_Logo.svg/1200px-Google_%22G%22_Logo.svg.png" height="14px" width="14px"> <a target="_blank" href="https://www.google.com/search?tbm=bks&q={{citation|get_title|bleach_safe}}">Google Books</a>
                <br>
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/WorldCat_logo.svg/440px-WorldCat_logo.svg.png" height="14px" width="46px" style="height: 14px; width: 14px; object-fit: cover; object-position: top left;"> <a target="_blank" href="https://www.worldcat.org/search?qt=worldcat_org_bks&q={{citation|get_title|bleach_safe}}">WorldCat</a>
                <br>
              {% endif %}

            </div>
        </div>

          <div class="panel panel-default">
            <div class="panel-heading"><i class="fas fa-link"></i> Citation URI</div>
            <div class="panel-body">
              <span class="authorityLink" style="cursor: copy;" title="Click to copy"><span class="hiddenCitationLink">{{ citation.generate_uri }}</span> <i class="far fa-copy"></i></span>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>

  <!-- for printing only -->
  <div class="col-sm-3 col-md-2 visible-print-block">
    <div class="menu hidden-print">
      <a href="{% if last_query %}{{ last_query }}{% else %}javascript:window.history.back(){% endif %}"><span class="glyphicon glyphicon-arrow-left"></span></a>
      &nbsp; &nbsp;
      <a href="{% url 'index' %}"><span class="glyphicon glyphicon-home"></span></a>
      &nbsp; &nbsp;
      <a href="{% url 'haystack_search' %}"><span class="glyphicon glyphicon-search"></span></a>
      <hr>
    </div>

    {% include "isisdata/citation_nav.html" %}

  </div>
</div>
<div class="row" ng-app="commentsApp">
  <div class="col-sm-12">
      {% include "isisdata/comments.html" %}

  </div>
</div>

{% endblock %}

<script>
    var textHolder = document.querySelector('.itemAbstract');
    var btn = document.querySelector('.readMore');

    function toggleText() {
    textHolder.classList.toggle("truncate");
    }

    btn.addEventListener('click', toggleText);
    toggleText(); //to truncate at first time
</script>
