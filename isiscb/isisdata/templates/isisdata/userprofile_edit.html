{% extends "isisdata/__base.html" %}
{% load app_filters %}
{% load citation_filters %}
{% load static %}
{% load metadata_filters %}
{% load search_filters %}

{% block content %}
<form action="{% url 'user_profile' username %}" method="post">
    {% csrf_token %}
    <div class="row">
        <div class="col-sm-6">
            <div class="panel">
                <div class="panel-heading clearfix">
                    <span class="h2">{{ username }}</span>
                    {% if is_staff %}<span class="label label-danger">Admin</span>{% endif %}
                    <span class="pull-right">
                        <input class="btn btn-success" type="submit" value="Save changes"></input>
                    </span>
                    {% if profile.authority_record %}
                    <div>
                        <a class="btn" href="{% url 'authority' profile.authority_record.id %}"><span class="fa fa-user"></span> View authority record</a>
                    </div>
                    {% endif %}
                </div>
                <div class="panel-body">
                    {% if form.non_field_errors %}
                        {% for error in form.non_field_errors %}
                        <div class="alert alert-danger">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                    <div class="row">
                        <div class="col-sm-6">
                            {% if form.first_name.errors %}
                                {% for error in form.first_name.errors %}
                                <div class="alert alert-danger">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                            <div class="input-group">
                                <label class="input-group-addon addon" for="first_name">First name</label>
                                {{ form.first_name }}
                            </div>
                        </div>
                        <div class="col-sm-6">
                            {% if form.last_name.errors %}
                                {% for error in form.last_name.errors %}
                                <div class="alert alert-danger">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                            <div class="input-group">
                                <label class="input-group-addon addon" for="last_name">Last name</label>
                                {{ form.last_name }}
                            </div>
                        </div>
                    </div>

                    <p><!-- The user may elect not to share their email address. -->
                        {% if form.email.errors %}
                            {% for error in form.email.errors %}
                            <div class="alert alert-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                        <div class="input-group">
                            <span class="input-group-addon addon" data-toggle="tooltip" data-placement="top" title="Email address"><span class="fa fa-envelope-o"></span></span>
                            {{ form.email }}
                        </div>
                    </p>
                    <p class="clearfix">
                        <div class="input-group">
                            {{ form.share_email }} Make email public
                        </div>
                    </p>

                    <p>
                        {% if form.affiliation.errors %}
                            {% for error in form.affiliation.errors %}
                            <div class="alert alert-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                        <div class="input-group">
                            <span class="input-group-addon addon" data-toggle="tooltip" data-placement="top" title="Affiliation"><span class="fa fa-building"></span></span>
                            {{ form.affiliation }}
                        </div>
                    </p>
                    <p>
                        {% if form.location.errors %}
                            {% for error in form.location.errors %}
                            <div class="alert alert-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                        <div class="input-group">
                            <span class="input-group-addon addon" data-toggle="tooltip" data-placement="top" title="Location"><span class="fa fa-home"></span></span>
                            {{ form.location }}
                        </div>
                    </p>
                    <p>
                        {% if form.resolver_institution.errors %}
                            {% for error in form.resolver_institution.errors %}
                            <div class="alert alert-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                        <div class="input-group">
                            <span class="input-group-addon addon" data-toggle="tooltip" data-placement="top" title="OpenURL Resolver"><span class="fa fa-book"></span></span>
                            {{ form.resolver_institution }}
                        </div>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="panel">
                <div class="panel-body">
                  <label>Interests</label>
                  <div id="subject-list-group" style="padding-bottom: 1em;">
                    {% if subjects %}
                      {% for subject in subjects %}
                        <a data-id="{{ subject.id }}" class="label label-primary link-label subject-tag">{{ subject.name }}</a>
                      {% endfor %}
                    {% endif %}
                  </div>
                  <input type="text" id="subjectSearchQuery" class="form-control input-sm" placeholder="Search to add interests . . .">
                  </input>
                  <ul class="list-group" id="subjectSearchResultsContainer">
                  </ul>
                </div>
            </div>

            <div class="panel">
                <div class="panel-heading">
                    <span class="h4">Bio</span>&nbsp;<span class="text text-info">(Accepts <a href="https://daringfireball.net/projects/markdown/syntax" target="_blank">markdown</a>)</span>
                </div>
                <div class="panel-body">
                    {{ form.bio }}
                </div>
            </div>
        </div>
    </div>
    <div class="row">

    </div>

</form>

<script>
    var INITIAL_MAX_RESULTS = 5;
    var max_results = INITIAL_MAX_RESULTS;
    var types = [];
    
    var searchTimerSubjects = 0;
    function triggerSearchSubjects(force) {
      if (searchTimerSubjects) {
          clearTimeout(searchTimerSubjects);
      }
    
      var query = $('#subjectSearchQuery').val();
      searchTimerSubjects = setTimeout(function() {
        $.ajax("{% url "curation:quick_and_dirty_authority_search" %}?exclude=CT,SE,IN&show_inactive=false&system=SPWT,SPWC,PN&use_custom_cmp=false&type=" + types + "&max=" + max_results + "&force=" + force + "&q=" + $('#subjectSearchQuery').val(), {
            success: function(result) {
              var resultsContainer = $('#subjectSearchResultsContainer');
              resultsContainer.empty();
              result.results.forEach(function(r) {
                var newLi = $("<li></li>");
                newLi.addClass("list-group-item");
                newLi.attr('data-acrelation-id', r.name);
                var publicLink = $('<a></a>');
                publicLink.attr('href', '{% url 'isis-index' %}authority/' + r.id);
                publicLink.attr('target', "_blank");
                publicLink.html(r.name + ' (' + r.citation_count + ')' );
                newLi.append(publicLink);
                newLi.append($('<span class="label label-primary pull-right">' + r.type + '</span>'));
                resultsContainer.append(newLi);
    
                var addBtn = $('<a href="#" data-id="' + r.id + '"></a>');
                addBtn.append('<i class="fa fa-plus-circle" aria-hidden="true" style="margin-right:10px;"></i>');
                addBtn.click(addConcept);
                newLi.prepend(addBtn);
              });
    
              if (result.results.length == 0 && ((force && query.length < 3) || (!force && query.length > 2))) {
                var msg = $('<p>There are no results for "' + $('#subjectSearchQuery').val() +'".</p>');
                resultsContainer.append(msg);
              } else if (result.results.length == 0 && !force && query.length < 3) {
                var msg = $('<p>Your query was too short. </p>');
                var forceLink = $('<a>Press <i class="fa fa-search" aria-hidden="true"></i></a>');
                forceLink.click(function() {
                  triggerSearchSubjects(true);
                });
                msg.append(forceLink);
                msg.append(" to force the search.");
                resultsContainer.append(msg);
              }
    
              if (result.results.length == max_results) {
                var load_more = `
                  <li class="list-group-item search-result">
                    <div class="text-right" id="load-more-subjects"><a>Load more...</a></div>
                  </li>
                `;
                resultsContainer.append(load_more);
                $('#load-more-subjects').click(function() {
                    max_results += 10;
                    triggerSearchSubjects(force);
                });
              }
            }
          });
      }, 500);
    }

    $(document).ready(function() {

        $("#forceSearch").click(function() {
          triggerSearchSubjects(true);
        });
      
        $('#subjectSearchQuery').on('keyup', function() {
          max_results = INITIAL_MAX_RESULTS;
          triggerSearchSubjects(false);
        });
    });
      
    // checkbox update display
    function updateDisplay($checkbox) {
        var isChecked = $checkbox.is(':checked');
        var $button = $checkbox.siblings('button')
        var color = $button.data('color');
    
        // Set the button's state
        $button.data('state', (isChecked) ? "on" : "off");
    
        if ($button.data('state') == 'on' || $button.data('state') == 'off') {
        // Set the button's icon
        $button.find('.state-icon')
            .removeClass()
            .addClass('state-icon ' + settings[$button.data('state')].icon);
    
        }
    
        // Update the button's color
        if (isChecked) {
            $button
                .removeClass('btn-default')
                .addClass('btn-' + color + ' active');
        }
        else {
            $button
                .removeClass('btn-' + color + ' active')
                .addClass('btn-default');
        }
    }

    function addConcept(event) {
        var link = event.target.closest('a');
        var acRelId = $(link).data('id');
        var headers = {
          'X-CSRFToken': '{{ csrf_token }}'
        };
        var payload = {
          'user_id': "{{ user.id }}",
          'authority_id': acRelId,
        };

        $.ajax({
          url: "{% url "quick_create_aurelation" username %}",
          method: "POST",
          headers: {'X-CSRFToken': '{{ csrf_token }}'},
          data: payload,
          dataType: "json"
          }).done(function(response) {
              let div = $('#subject-list-group');
              let tagId = response.authority.id;
              let tagName = response.authority.name;

              let newTag = $(`<span data-id="${tagId}" class="label label-primary link-label subject-tag"><span>${tagName}</span></span>`);

              div.append(newTag);

          }).fail(function (error) {
              console.log(error);
          });
    }

    function removeConcept(event) {
      authorityId = $(event.target).data('id');

      var headers = {
        'X-CSRFToken': '{{ csrf_token }}'
      };
      var payload = {
        'user_id': "{{ user.id }}",
        'authority_id': authorityId,
      };

      $.ajax({
        url: "{% url "quick_delete_aurelation" username %}",
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        data: payload,
        dataType: "json"
        }).done(function(response) {

            $('#subject-list-group').find(`[data-id='${response.authority.id}']`).remove();
        }).fail(function (error) {
            console.log(error);
        });
    }

    $(document.body).on('mouseenter', '.subject-tag', function(){
        $(this).css({"background-color": "red"}).append('<span class="delete-icon">&nbsp;<i class="far fa-times-circle"></i></span>');
    }).on('mouseleave', '.subject-tag', function(){
        $(this).css({"background-color": "#337ab7"});
        $(this).find(".delete-icon").remove();
    });

    $('.subject-tag').click(removeConcept);
</script>
{% endblock %}
